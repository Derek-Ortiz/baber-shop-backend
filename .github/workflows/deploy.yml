name: Deploy BarberShop API to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew build -x test

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r build/libs/*.jar deploy/
        cp -r src/main/resources/* deploy/ 2>/dev/null || true

    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
      run: |
        # Crear archivo de clave privada con el formato correcto
        echo "$PRIVATE_KEY" | tr -d '\r' > private_key.pem
        chmod 600 private_key.pem
        
        # Verificar que la clave se creÃ³ correctamente
        if [ ! -s private_key.pem ]; then
          echo "Error: El archivo de clave privada estÃ¡ vacÃ­o"
          exit 1
        fi
        
        # Crear directorio en EC2 si no existe
        ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} '
          mkdir -p ~/barbershop-api
        '
        
        # Copiar archivos al servidor
        scp -o StrictHostKeyChecking=no -i private_key.pem -r deploy/* ${USER}@${HOST}:~/barbershop-api/
        
        # Copiar script de inicio
        scp -o StrictHostKeyChecking=no -i private_key.pem scripts/start-service.sh ${USER}@${HOST}:~/barbershop-api/
        
        # Ejecutar deployment en el servidor
        ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} '
          cd ~/barbershop-api
          chmod +x *.sh
          ./start-service.sh
          
          # Esperar un poco para que el proceso inicie
          sleep 10
          
          # DiagnÃ³stico inline
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” DiagnÃ³stico del Servicio"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Verificar proceso
          if ps aux | grep -v grep | grep java > /dev/null; then
            echo "âœ… Proceso Java corriendo"
            ps aux | grep -v grep | grep java | head -n 1
          else
            echo "âŒ No hay proceso Java corriendo"
          fi
          
          echo ""
          echo "ğŸ“ Ãšltimas 30 lÃ­neas del log:"
          echo "----------------------------------------"
          tail -n 30 app.log || echo "No se pudo leer el log"
          
          echo ""
          echo "ğŸŒ Puerto 9090:"
          netstat -tlnp 2>/dev/null | grep 9090 || echo "Puerto 9090 no estÃ¡ escuchando"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        '
        
        # Limpiar
        rm -f private_key.pem

    - name: Verify deployment
      env:
        HOST: ${{ secrets.EC2_HOST }}
      run: |
        echo "Esperando 30 segundos para que el servicio inicie..."
        sleep 30
        
        # Verificar que el servicio responda
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${HOST}:9090/api/health || echo "000")
        
        if [ "$response" = "200" ]; then
          echo "âœ… Deployment exitoso! API respondiendo correctamente"
        else
          echo "âš ï¸ Advertencia: El servicio puede estar iniciando. CÃ³digo de respuesta: $response"
        fi

